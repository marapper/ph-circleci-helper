description: >
  Tag an existing docker image and pushes it to the registry

parameters:
  artifact-registry-url:
    type: env_var_name
    default: DOCKER_REGISTRY_URL
    description: |
      Name of environment variable storing the docker artifact registry url in the
      <region>-docker.pkg.dev/<project>/<name> format

  team:
    type: string
    description: |
      Name of the team owning the application.

  app:
    type: string
    description: |
      Name of the application.

  tag:
    type: string
    default: ""
    description: |
      Tag of the image built. If not given, defaults to '${CIRCLE_WORKFLOW_ID}.${CIRCLE_SHA1}'

  source-tag:
    type: string
    description: |
      Original tag of the image built. Will be retagged to match the Artifact registry format

  rolling-tag:
    type: boolean
    default: true
    description: |
      Whether or not to automatically push rolling tags for images.
      These rolling tags are designed for artifact registry cleanup and pinning the specific images remains
      the preferred method for updating images in ph-releaser.

steps:
  - run:
      name: Push image
      command: |
        IMAGE_FULL_PATH="${<< parameters.artifact-registry-url >>}/<< parameters.team >>/<< parameters.app >>"

        if [[ -z "<< parameters.tag >>" ]]; then
          IMAGE_TAG="${CIRCLE_WORKFLOW_ID}.${CIRCLE_SHA1}"
        else
          NON_NORMALIZED_IMAGE_TAG="<< parameters.tag >>"
          # replaces all / with _ (https://tldp.org/LDP/abs/html/string-manipulation.html)
          IMAGE_TAG=${NON_NORMALIZED_IMAGE_TAG//\//_}
        fi

        IMAGE="${IMAGE_FULL_PATH}:${IMAGE_TAG}"
        docker tag << parameters.source-tag >> $IMAGE
        docker push $IMAGE
  - when:
      condition: << parameters.rolling-tag >>
      steps:
        - run:
            name: Push rolling tag
            command: |
              TAG=$CIRCLE_TAG
              # tags will be favored over branches
              if [[ -z "$CIRCLE_TAG" ]]; then
                TAG=$CIRCLE_BRANCH
              fi
              # replaces all / with - (https://tldp.org/LDP/abs/html/string-manipulation.html)
              TAG=${TAG//\//-}
              # lower case all strings
              TAG=$(echo $TAG | tr "[:upper:]" "[:lower:]")

              IMAGE="${<< parameters.artifact-registry-url >>}/<< parameters.team >>/<< parameters.app >>:$TAG"
              docker tag << parameters.source-tag >> $IMAGE
              docker push $IMAGE